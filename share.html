<?php
session_start();

// ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á IP:
// 1. ‡∏à‡∏≤‡∏Å POST (‡∏ñ‡πâ‡∏≤ User ‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)
// 2. IP ‡∏ó‡∏µ‡πà User ‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (172.18.108.235)
// 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
$default_ip = "172.18.108.235"; 

function getAutoIP() {
    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        $ip = gethostbyname(gethostname());
    } else {
        $ip = $_SERVER['SERVER_ADDR'] ?? 'localhost';
    }
    return ($ip == '127.0.0.1' || $ip == '::1') ? "172.18.108.235" : $ip;
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡πÅ‡∏•‡∏∞ IP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
$default_ip = "172.18.108.235"; 
$current_path = "/eSupport/apartment"; 

// ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô IP ‡∏´‡∏£‡∏∑‡∏≠ Public URL ‡∏à‡∏≤‡∏Å ngrok ‡∏Å‡πá‡πÑ‡∏î‡πâ)
$user_input = isset($_POST['custom_url']) ? trim($_POST['custom_url']) : $default_ip;

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ngrok) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà IP
if (strpos($user_input, 'http') === 0) {
    $hub_url = $user_input;
} else {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà IP ‡∏´‡∏£‡∏∑‡∏≠ Domain ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° http ‡πÅ‡∏•‡∏∞ path
    $clean_host = trim($user_input, "/ ");
    $hub_url = "http://" . $clean_host . $current_path;
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code (‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏á‡πà‡∏≤‡∏¢)
$qr_api = "https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=" . urlencode($hub_url);
$is_public = (strpos($hub_url, 'ngrok') !== false || strpos($hub_url, 'https') === 0);
?>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Hub - <?php echo $local_ip; ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #274472;
            --secondary: #1a2d50;
            --accent: #3a6098;
            --bg: #0a1628;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #050f1e, #1a2d50);
            min-height: 100vh;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* QR Frame Design - Cleaner and more scanable */
        .qr-frame {
            background: white;
            padding: 40px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏£‡∏≠‡∏ö QR (Quiet Zone) */
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 380px;
            width: 100%;
            border: 2px solid #e2e8f0;
        }

        .qr-img {
            width: 280px;
            height: 280px;
            margin-bottom: 0;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î */
            image-rendering: crisp-edges;
        }

        .info-panel {
            margin-top: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 24px;
            color: white;
            width: 100%;
            max-width: 500px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .troubleshoot {
            margin-top: 20px;
            font-size: 12px;
            background: rgba(255, 100, 100, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 100, 100, 0.2);
            text-align: left;
        }
        .troubleshoot ul { margin-left: 20px; margin-top: 5px; }

        .url-text {
            font-family: monospace;
            background: white;
            color: var(--primary);
            padding: 12px;
            border-radius: 12px;
            margin: 15px 0;
            word-break: break-all;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .hub-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .hub-btn:hover {
            background: white;
            color: var(--primary);
        }

        .ip-edit {
            margin-top: 20px;
            display: flex;
            gap: 8px;
        }

        .ip-edit input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
            flex: 1;
        }

        .ip-edit button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .back-link {
            margin-top: 25px;
            color: rgba(255,255,255,0.5);
            text-decoration: none;
            font-size: 13px;
        }
        .back-link:hover { color: white; }

        @media (max-width: 480px) {
            .qr-img { width: 200px; height: 200px; }
            .scan-me-label { font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="qr-frame">
        <img src="<?php echo $qr_api; ?>" alt="QR Code" class="qr-img">
    </div>

    <div class="info-panel">
        <h2 style="font-size: 22px; margin-bottom: 12px;">
            <?php echo $is_public ? 'üåê Public Access (Online)' : 'üì± Local Access (WiFi)'; ?>
        </h2>
        <p style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå:</p>
        
        <div class="url-text"><?php echo $hub_url; ?></div>

        <div class="btn-grid">
            <a href="login.php" class="hub-btn"><i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="index.php" class="hub-btn"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <a href="diagrams/index.html" class="hub-btn"><i class="fas fa-project-diagram"></i> ‡πÑ‡∏î‡∏≠‡∏∞‡πÅ‡∏Å‡∏£‡∏°</a>
        </div>

        <form class="ip-edit" method="POST">
            <input type="text" name="custom_url" value="<?php echo $user_input; ?>" placeholder="‡πÉ‡∏™‡πà IP ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏à‡∏≤‡∏Å ngrok...">
            <button type="submit">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR</button>
        </form>

        <?php if (!$is_public): ?>
        <div class="troubleshoot">
            <strong>üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà (‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï 4G/5G):</strong>
            <p style="font-size: 13px; margin-top: 10px;">
                1. ‡∏£‡∏±‡∏ô <code>ngrok http 80</code> ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ<br>
                2. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå <code>https://...</code> ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï<br>
                3. ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å!
            </p>
        </div>
        <div class="troubleshoot" style="background: rgba(255,255,255,0.05); color: #cbd5e1; border-color: rgba(255,255,255,0.1);">
            <strong>‚ö†Ô∏è ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î?</strong>
            <ul style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                <li>‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠ WiFi ‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</li>
                <li>‡πÄ‡∏ä‡πá‡∏Ñ IP ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô XAMPP</li>
                <li>‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î Windows Firewall ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>
            </ul>
        </div>
        <?php else: ?>
        <div class="troubleshoot" style="background: rgba(40, 167, 69, 0.15); border-color: rgba(40, 167, 69, 0.3); color: #a3cfbb;">
            <strong style="color: #fff;">‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!</strong><br>
            ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå QR ‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
        </div>
        <?php endif; ?>
    </div>

    <a href="index.php" class="back-link"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

</body>
</html>
